<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Cognitive Backend Debugger v2</title>
    <style>
        body {
            background: #0f0f10; color: #ccc;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex; gap: 20px; padding: 20px; height: 95vh;
        }

        /* Layout */
        #left-panel { flex: 0 0 auto; display: flex; flex-direction: column; }
        #right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 300px; }

        /* Map Container */
        #viewport {
            border: 2px solid #333;
            background: #000;
            display: inline-block;
            padding: 5px;
        }

        /* Grid Logic */
        #game-map {
            display: grid;
            /* Columns/Rows set via JS */
        }

        .tile {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; cursor: default;
        }

        /* Entity Colors */
        .wall {
            background: #444;
            color: #aaa;
        }
        .floor {
            background: #111;
            color: #333;
        }
        .fog {
            opacity: 0.3;
        }
        .player { color: #0ff; font-weight: bold; text-shadow: 0 0 5px #0ff; }
        .enemy { color: #f55; font-weight: bold; }
        .npc { color: #fb0; }
        .item { color: #d0f; }
        .corpse { color: #555; }

        /* Logs */
        #logs-container {
            flex: 1; border: 1px solid #333; background: #050505;
            padding: 10px; overflow-y: auto; font-size: 13px;
            display: flex; flex-direction: column;
        }
        .log-entry { margin-bottom: 4px; line-height: 1.4; border-bottom: 1px solid #1a1a1a; }
        .ts { color: #555; margin-right: 8px; font-size: 11px; }
        .type-INFO { color: #8cf; }
        .type-ERROR { color: #f55; }
        .type-COMBAT { color: #f55; font-weight: bold; }
        .type-SPEECH { color: #fdaa; font-style: italic; }

        /* Controls */
        .controls-area { background: #1a1a1a; padding: 15px; border-radius: 8px; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 120px; margin-bottom: 15px; }
        button {
            background: #333; color: white; border: 1px solid #555;
            padding: 10px; cursor: pointer; border-radius: 4px;
            font-family: inherit; font-weight: bold;
        }
        button:hover { background: #444; border-color: #777; }
        button:active { background: #555; transform: translateY(1px); }

        textarea {
            width: 100%; height: 50px; background: #222; color: #fff;
            border: 1px solid #444; padding: 5px; font-family: monospace; margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div id="left-panel">
    <div id="viewport">
        <div id="game-map">Connecting...</div>
    </div>
    <div style="margin-top: 10px; font-size: 12px; color: #777;">
        Status: <span id="status" style="color: yellow">Wait</span> |
        Tick: <span id="tick" style="color: white">0</span> |
        Pos: <span id="pos" style="color: white">0,0</span>
    </div>
</div>

<div id="right-panel">
    <div class="controls-area">
        <div class="d-pad">
            <div></div>
            <button onclick="cmd('MOVE', {dy: -1, dx: 0})">▲</button>
            <div></div>
            <button onclick="cmd('MOVE', {dx: -1, dy: 0})">◀</button>
            <button onclick="cmd('WAIT', {})">Wait</button>
            <button onclick="cmd('MOVE', {dx: 1, dy: 0})">▶</button>
            <div></div>
            <button onclick="cmd('MOVE', {dy: 1, dx: 0})">▼</button>
            <div></div>
        </div>

        <div>
            <textarea id="raw-json">{"action": "TALK", "payload": "Привет!"}</textarea>
            <button onclick="sendRaw()" style="width: 100%">Send Raw JSON</button>
        </div>
    </div>

    <div id="logs-container"></div>
</div>

<script>
    const ws = new WebSocket("ws://localhost:8080/ws");
    const mapContainer = document.getElementById("game-map");
    const logsContainer = document.getElementById("logs-container");

    // State cache to avoid redraws
    let gridInitialized = false;
    let gridW = 0, gridH = 0;

    ws.onopen = () => {
        document.getElementById("status").innerText = "CONNECTED";
        document.getElementById("status").style.color = "#0f0";
    };

    ws.onclose = () => {
        document.getElementById("status").innerText = "DISCONNECTED";
        document.getElementById("status").style.color = "#f00";
    };

    ws.onmessage = (evt) => {
        const msg = JSON.parse(evt.data);

        if (msg.type === "INIT" || msg.type === "UPDATE") {
            if (msg.world) renderWorld(msg.world);
            if (msg.player) updateHUD(msg.player, msg.world?.globalTick);

            // Render entities on top of the world
            if (msg.world && msg.player) {
                drawEntities(msg.player, msg.entities || []);
            }

            if (msg.logs) renderLogs(msg.logs);
        }
    };

    function cmd(action, payload) {
        if(ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ action, payload }));
        }
    }

    function sendRaw() {
        try {
            const val = document.getElementById("raw-json").value;
            ws.send(val);
        } catch(e) { alert("Bad JSON"); }
    }

    // --- Rendering ---

    function initGrid(w, h) {
        mapContainer.innerHTML = '';
        mapContainer.style.gridTemplateColumns = `repeat(${w}, 20px)`;
        mapContainer.style.gridTemplateRows = `repeat(${h}, 20px)`;

        for(let y=0; y<h; y++) {
            for(let x=0; x<w; x++) {
                const div = document.createElement("div");
                div.id = `c-${x}-${y}`;
                div.className = "tile";
                mapContainer.appendChild(div);
            }
        }
        gridW = w; gridH = h;
        gridInitialized = true;
    }

    function renderWorld(world) {
        // Инициализация сетки (один раз)
        if (!gridInitialized || gridW !== world.width || gridH !== world.height) {
            initGrid(world.width, world.height);
        }

        // Обновление тайлов
        world.map.forEach(row => {
            row.forEach(tile => {
                const el = document.getElementById(`c-${tile.x}-${tile.y}`);
                if (!el) return;

                // 1. Сброс и Базовая логика (Всегда применяем классы!)
                el.className = "tile";

                if (tile.isWall) {
                    el.classList.add("wall");
                    el.innerText = "#";
                } else {
                    el.classList.add("floor");
                    el.innerText = ".";
                }

                // 2. Визуализация "Тумана войны" (Опционально для дебага)
                // Если сервер говорит "не видно", делаем полупрозрачным, но НЕ скрываем
                if (!tile.isVisible && !tile.isExplored) {
                    // el.classList.add("fog"); // Раскомментируй, если хочешь видеть зоны видимости
                }
            });
        });
    }

    function drawEntities(player, entities) {
        // Draw Others
        entities.forEach(e => {
            const el = document.getElementById(`c-${e.pos.x}-${e.pos.y}`);
            if (el) {
                el.innerText = e.symbol;
                el.className = "tile"; // reset

                if (e.isDead) el.classList.add("corpse");
                else if (e.type === "ENEMY") el.classList.add("enemy");
                else if (e.type === "NPC") el.classList.add("npc");
                else if (e.type === "ITEM") el.classList.add("item");
            }
        });

        // Draw Player
        const pEl = document.getElementById(`c-${player.pos.x}-${player.pos.y}`);
        if (pEl) {
            pEl.innerText = player.symbol;
            pEl.className = "tile player";
        }
    }

    function updateHUD(player, tick) {
        document.getElementById("pos").innerText = `${player.pos.x},${player.pos.y}`;
        document.getElementById("tick").innerText = tick || 0;
    }

    function renderLogs(logs) {
        if (!logs || logs.length === 0) return;

        logs.forEach(l => {
            const div = document.createElement("div");
            div.className = `log-entry type-${l.type}`;

            const time = new Date(l.timestamp).toLocaleTimeString([], {hour12:false});
            div.innerHTML = `<span class="ts">[${time}]</span> ${l.text}`;
            logsContainer.appendChild(div);
        });

        // Scroll to bottom
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }
</script>

</body>
</html>